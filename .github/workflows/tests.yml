name: Tests

on:
  pull_request:
  push:

env:
  GH_TOKEN: ${{ secrets.GH_TOKEN }}

jobs:
  tests:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        version:
          - binary:stable
        os:
          - ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - uses: extractions/setup-just@v2

    - name: Cache Nim
      uses: actions/cache@v3
      with:
        path: |
          ~/.nimble
          ~/.cache/nim
        key: ${{ runner.os }}-nim-${{ matrix.version }}-${{ hashFiles('*.nimble') }}
        restore-keys: |
          ${{ runner.os }}-nim-${{ matrix.version }}-
          ${{ runner.os }}-nim-

    - uses: iffy/install-nim@v5
      with:
        version: ${{ matrix.version }}

    - uses: extractions/setup-just@v2

    - name: Install Apache Arrow repository
      run: |
        wget https://apache.jfrog.io/artifactory/arrow/$(lsb_release --id --short | tr 'A-Z' 'a-z')/apache-arrow-apt-source-latest-$(lsb_release --codename --short).deb
        sudo apt-get install -y ./apache-arrow-apt-source-latest-$(lsb_release --codename --short).deb
        sudo apt-get update

    - name: Cache apt packages
      uses: awalsh128/cache-apt-pkgs-action@latest
      with:
        packages: clang libclang-dev libarrow-dev libarrow-glib-dev libglib2.0-dev libgirepository1.0-dev pkg-config
        version: 1.0

    - name: Verify installations
      run: |
        echo "=== Arrow GLib ==="
        pkg-config --modversion arrow-glib
        echo "=== GObject ==="
        pkg-config --modversion gobject-2.0
        echo "=== GLib ==="
        pkg-config --modversion glib-2.0
        echo "=== Clang ==="
        clang --version
        echo "=== Include paths ==="
        pkg-config --cflags-only-I arrow-glib gobject-2.0 glib-2.0

    - name: Install Nim dependencies
      run: nimble install -y

    - name: Test
      # run: LSAN_OPTIONS=suppressions=lsan.supp nimble test -d:useSanitizers
      run: LSAN_OPTIONS=suppressions=lsan.supp just test-debug-par
